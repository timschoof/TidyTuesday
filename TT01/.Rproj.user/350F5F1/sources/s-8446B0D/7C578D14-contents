###attempts at non-linear models..
## using http://ase.tufts.edu/gsc/gradresources/guidetomixedmodelsinr/mixed%20model%20guide.html

library(car)
library(moments)
library(Rcpp)  # nodig voor de multilevel modeling
library(ggplot2)  # om grafieken te maken
library(lme4) # multilevel modeling
library(lmerTest) # OM FUNCTIE rand()  te kunnen gebruiken!
library(lattice)
library(multcomp)
library(dplyr)
options(scipen=999)  # geen wetenschappenlijke notering hebben (geen getal*e tot de -Xe ...)

# Functies om logits om te rekenen naar probabiliteiten
back_odds= function(X) { 
  exp(X)
}
alog= function(X) { 
  back_odds(X)/(1+back_odds(X))
}

COMPLETEPITCH_word_durMLUnoRob <- read.csv(file.choose())
###plotting first to see which type of distribution my data is

require(car)
## Loading required package: car
require(MASS)
# This is so that distributions that must be non-zero can make sense of my
# data??

#checking for normal distribution, clearly non-normal!
COMPLETEPITCH_word_durMLUnoRob$consS1percent.t <- COMPLETEPITCH_word_durMLUnoRob$consS1percent + 1
qqp(COMPLETEPITCH_word_durMLUnoRob$consS1percent.t, "norm")

#log-normal? no!
qqp(COMPLETEPITCH_word_durMLUnoRob$consS1percent.t, "lnorm")

#negative binomial? wont work, x contains infintie or missing values
nbinom <- fitdistr(dd$consS1percent.t, "Negative Binomial")
qqp(dd$consS1percent.t, "nbinom", size = nbinom$estimate[[1]], mu = nbinom$estimate[[2]])

# checking if there are na:
sum(is.na(COMPLETEPITCH_word_durMLUnoRob$consS1percent.t))

# new vector without na

#dd <- c(na.exclude(COMPLETEPITCH_word_durMLUnoRob))
dd<-COMPLETEPITCH_word_durMLUnoRob[complete.cases(COMPLETEPITCH_word_durMLUnoRob$consS1percent),]

sum(is.na(dd$consS1percent))



#poisson? nope..
poisson <- fitdistr(dd$consS1percent.t, "Poisson")
qqp(dd$consS1percent.t, "pois", poisson$estimate)

#gamma - YES!!
gamma <- fitdistr(dd$consS1percent.t, "gamma")
qqp(dd$consS1percent.t, "gamma", shape = gamma$estimate[[1]], rate = gamma$estimate[[2]])

##### ANALYSES FOR S1consperc USING GAMMA DISTRIBUTION! #####

# adding .0001 as gamma family can't cope iwth 0

dd$trans_consS1perc <- dd$consS1percent + 0.0001

min(dd$trans_consS1)

# random effects, random slopes & intercepts... model not converging.. why?
gm1 <- glmer(trans_consS1perc~1+(1+age_mths|id),data=dd, family = Gamma)
summary(gm1)

min(dd$age_mths)

# taking a simpler model with only random intercepts in random part
gm2 <- glmer(trans_consS1perc~1+(1|id),data=dd, family = Gamma)
summary(gm2)

# group in fixed effects of simpler model, fit ns, group ns
gm3 <- glmer(trans_consS1perc~1+impaired+(1|id),data=dd, family = Gamma)
summary(gm3)
anova(gm2, gm3, test='Chi')









#checking for linearity...
#with residuals-plot
plot(fitted(simplcS1a),residuals(simplcS1a))
# and qq-plot.
qqnorm(residuals(simplcS1a))



# group in fixed effects of simpler model, fit ns, group ns
simplcS1c <- lmer(consS1percent~1+impaired+(1|id),data=COMPLETEPITCH_word_durMLUnoRob, REML=FALSE)
summary(simplcS1c)
anova(simplcS1a, simplcS1c, test='Chi')

# status in fixed effects of simpler model, fit ns, status ns
simplcS1d <- lmer(consS1percent~1+status+(1|id),data=COMPLETEPITCH_word_durMLUnoRob, REML=FALSE)
summary(simplcS1d)
anova(simplcS1a, simplcS1d, test='Chi')

# checking for both group & status, just in case, fit NS, group ns, status ns -> model with only random intercept best fit!
simplcS1e <- lmer(consS1percent~1+status+impaired+(1|id),data=COMPLETEPITCH_word_durMLUnoRob, REML=FALSE)
summary(simplcS1e)
anova(simplcS1a, simplcS1e, test='Chi')




